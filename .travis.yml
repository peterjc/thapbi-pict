# This is a special configuration file to run tests on Travis-CI via
# GitHub notifications when changes are committed.
#
# This file is not intended for end users of the tool.

# We don't need sudo so can avoid slower legacy TravisCI infrastructure
sudo: false
dist: xenial
addons:
  apt:
    # Would like to insert the requirements-ext.txt file but names differ...
    packages:
     - ncbi-blast+
     # cutadapt
     # flash
     - graphviz
     - hmmer
     - swarm
     - trimmomatic
     - unzip
language: python
python: "3.6"
cache: pip

before_install:
 - "if grep -n -P '\t' *.rst */*.rst */*/*.rst; then echo 'Tabs are bad, please use four spaces in RST files.'; false; fi"
 - "if grep -n -P '\t' .circleci/*.yml ; then echo 'Tabs are bad, please use four spaces in Yaml files.'; false; fi"
 - "if grep -n -P '\t' */*.py ; then echo 'Tabs are bad, please use four spaces in Python files.'; false; fi"
 - "if grep -n -r '[[:blank:]]$' *.rst */*.rst */*/*.rst; then echo 'Please remove trailing whitespace in RST files.'; false; fi"
 - "if grep -n -r '[[:blank:]]$' *.yml .circleci/*.yml ; then echo 'Please remove trailing whitespace in Yaml files.'; false; fi"
 - "if grep -n -r '[[:blank:]]$' */*.py; then echo 'Please remove trailing whitespace in Python files.'; false; fi"
 - grep -v '^>' database/Phytophthora_ITS1_curated.fasta  | sort -u -c -f
 - python -m pip install --upgrade pip setuptools
 # pydocstyle==4.0.0 broke flake8-docstrings https://gitlab.com/pycqa/flake8-docstrings/issues/36
 - python -m pip install flake8==3.6 flake8-black flake8-blind-except "pydocstyle<4.0.0" flake8-docstrings flake8-rst-docstrings restructuredtext-lint flake8-bugbear flake8-pie flake8-comprehensions pygments
 - echo "Using flake8 (including black) to check Python code"
 - flake8 .
 - echo "Using restructuredtext-lint to check non-Sphinx documentation"
 - restructuredtext-lint *.rst database/*.rst tests/*/*.rst

install:
 # Already installed external dependencies with apt packages (above)
 # Deliberatly not installing Python dependencies here, pip should do it...
 # python -m pip install -r requirements.txt
 # Make a tar-ball, and try installing from that
 - rm -rf dist/* thapbi_pict/ITS1_DB.sqlite
 - sqlite3 thapbi_pict/ITS1_DB.sqlite < database/ITS1_DB.sql
 - chmod a-w thapbi_pict/ITS1_DB.sqlite
 - python setup.py sdist --formats=gztar
 - python setup.py bdist_wheel
 - cd dist
 - python -m pip install thapbi_pict-*.whl
 - cd ..

script:
 # Now unpack tests from the sdist tar-ball
 - tar --wildcards '*/tests/*' -zxvf dist/thapbi_pict-*.tar.gz
 - tar --wildcards '*/database/*' -zxvf dist/thapbi_pict-*.tar.gz
 - tar --wildcards '*/controls.hmm*' -zxvf dist/thapbi_pict-*.tar.gz
 - cd thapbi_pict-*/
 # Run the tests (and confirm the tar-ball is complete)
 - tests/run_tests.sh
